<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kpop Space - Search</title>
    <link rel="stylesheet" href="/SearchPage.css">
    <link rel="stylesheet" href="/Header.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Afacad:ital,wght@0,400..700;1,400..700&family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Header -->
    <header>
        <nav class="navbar">
            <div class="logo">
                <img class="logos" src="/IMG_5349.jpg" alt="Web logo">
            </div>
            <div class="nav-buttons">
                <a href="/SearchPage.html"><button class="nav-item">Search</button></a>
                <a href="/HomePage.html"><button class="nav-item">HOME</button></a>
                <a href="/teammember.html"><button class="nav-item">TEAM</button></a>
                <a href="/AllPro.html"><button class="nav-item">PRODUCT</button></a>
            </div>
            <div class="user-controls">
                <a href="/login.html"><i class="bi bi-person-circle"></i></a>
                <a href="/AddEdit.html"><i class="bi bi-hammer"></i></a>
            </div>
        </nav>
    </header>

    <main>
        <div class="search-and-trending">
            <form id="searchForm">
                <label>Name</label>
                <input type="text" id="name" placeholder="Enter name"><br><br>

                <label>Artist</label>
                <input type="text" id="artist" placeholder="Enter artist"><br><br>

                <label>Label</label>
                <input type="text" id="label" placeholder="Enter label"><br><br>

                <button type="submit" class="searching-button">SEARCH</button>
                <button type="button" class="clear-button" onclick="clearForm()">CLEAR</button>
            </form>

            <div class="recent-searches">
                <h3>Recent Searches</h3>
                <ul id="recentSearch"></ul>
            </div>
        </div>

        <h2 class="Show-product">Product Overview</h2>
        <div class="product-container" id="product-container">
            <!-- Products will be dynamically inserted here -->
        </div>
    </main>

    <script src="/Header.js"></script>
    <script>
        const productContainer = document.getElementById('product-container');

        async function fetchProducts(query = '') {
            try {
                const url = query
                    ? `http://localhost:8003/api/search?${query}`
                    : 'http://localhost:8003/api/products';

                const response = await fetch(url, {
                    method: 'GET',
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error(`Failed to fetch products: ${response.statusText}`);
                }

                const data = await response.json();
                renderProducts(data.results || data);
            } catch (error) {
                console.error('Error fetching products:', error);
                productContainer.innerHTML = '<p>Failed to load products. Please check your connection or try again later.</p>';
            }
        }

        function renderProducts(products) {
            productContainer.innerHTML = '';
            if (!products || products.length === 0) {
                productContainer.innerHTML = '<p>No products found.</p>';
                return;
            }

            products.forEach(product => {
                const productCard = `
                    <div class="product-card" onclick="window.location.href='/ProductDetail?product_id=${product.product_ID}'">
                        <img src="${product.Product_Image}" alt="${product.Name}">
                        <h3>${product.Name}<br><span class="price">${product.price} THB</span></h3>
                        <button class="add-to-cart"><i class="bi bi-cart cart-icon"></i> Add to cart</button>
                    </div>
                `;
                productContainer.innerHTML += productCard;
            });
        }

        document.getElementById('searchForm').addEventListener('submit', function (e) {
            e.preventDefault();

            const name = document.getElementById('name').value.trim();
            const artist = document.getElementById('artist').value.trim();
            const label = document.getElementById('label').value.trim();

            // Create search term
            const searchTerm = [name, artist, label].filter(Boolean).join(', ');
            if (searchTerm) {
                // Store in localStorage
                let recentSearches = JSON.parse(localStorage.getItem('recentSearches') || '[]');
                recentSearches = [searchTerm, ...recentSearches.filter(term => term !== searchTerm)].slice(0, 5);
                localStorage.setItem('recentSearches', JSON.stringify(recentSearches));

                // Update recent search list
                updateRecentSearches();
            }

            const params = new URLSearchParams();
            if (name) params.append('name', name);
            if (artist) params.append('artist', artist);
            if (label) params.append('label', label);

            fetchProducts(params.toString());
        });

        function clearForm() {
            document.getElementById('searchForm').reset();
            fetchProducts();
        }

        function updateRecentSearches() {
            const recentSearchList = document.getElementById('recentSearch');
            recentSearchList.innerHTML = '';
            const recentSearches = JSON.parse(localStorage.getItem('recentSearches') || '[]');
            recentSearches.forEach(term => {
                const li = document.createElement('li');
                li.textContent = term;
                recentSearchList.appendChild(li);
            });
        }

        // Load all products and recent searches on page load
        window.onload = () => {
            fetchProducts();
            updateRecentSearches();
        };
    </script>
</body>
</html>